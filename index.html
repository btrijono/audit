<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Penilaian Land Clearing</title>
  
  <!-- CSS Libraries -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    #map { height: 100vh; }
    .sidebar { 
      background: #f8f9fa;
      height: 100vh;
      overflow-y: auto;
      box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    }
    .criteria-card { 
      border-left: 4px solid #28a745;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    .criteria-card:hover { transform: translateY(-3px); }
    .photo-preview { max-height: 100px; cursor: pointer; }
    .score-badge { font-size: 0.8rem; }
    #legend { 
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .leaflet-control-layers { overflow-y: auto; max-height: 300px; }
    .grade-A { background-color: #28a745 !important; }
    .grade-B { background-color: #17a2b8 !important; }
    .grade-C { background-color: #ffc107 !important; }
    .grade-D { background-color: #fd7e14 !important; }
    .grade-E { background-color: #dc3545 !important; }
    .loading-spinner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .loading-spinner.active {
      display: flex;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    .alert-position {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
    }
    /* CSS untuk Laporan */
    #reportMap {
      min-height: 300px;
      border-radius: 0 0 5px 5px;
    }
    #reportLineTable th {
      position: sticky;
      top: 0;
      background-color: #f8f9fa;
      z-index: 10;
    }
    .modal-xl .modal-body {
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
    .grade-badge {
      font-size: 0.9rem;
      padding: 5px 10px;
      border-radius: 10px;
    }
    @media print {
      body * {
        visibility: hidden;
      }
      #reportModal, #reportModal * {
        visibility: visible;
      }
      #reportModal {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: auto;
        margin: 0;
        padding: 0;
        border: none;
      }
      .modal-footer, .btn-close {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Spinner -->
  <div class="loading-spinner" id="loadingSpinner">
    <div class="spinner-border text-light" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Alert Container -->
  <div class="alert-position" id="alertContainer"></div>

  <!-- Modal Laporan -->
  <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="reportModalLabel">
            <i class="fas fa-file-alt me-2"></i>Laporan Summary Penilaian
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header bg-info text-white">
                  <i class="fas fa-info-circle"></i> Informasi Proyek
                </div>
                <div class="card-body" id="reportProjectInfo"></div>
              </div>
              <div class="card">
                <div class="card-header bg-info text-white">
                  <i class="fas fa-chart-pie"></i> Statistik Grade
                </div>
                <div class="card-body">
                  <canvas id="gradeChart" height="250"></canvas>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header bg-info text-white">
                  <i class="fas fa-table"></i> Detail Penilaian per Jalur
                </div>
                <div class="card-body table-responsive" style="max-height: 400px;">
                  <table class="table table-striped table-hover" id="reportLineTable">
                    <thead>
                      <tr>
                        <th>Jalur</th>
                        <th>Total Skor</th>
                        <th>Grade</th>
                        <th>Detail</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
              <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between">
                  <span><i class="fas fa-map-marked-alt"></i> Peta Sebaran</span>
                  <button class="btn btn-sm btn-light" onclick="exportReport()">
                    <i class="fas fa-download"></i> Export PDF
                  </button>
                </div>
                <div class="card-body p-0" style="height: 300px;">
                  <div id="reportMap" style="height: 100%;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          <button type="button" class="btn btn-primary" onclick="printReport()">
            <i class="fas fa-print"></i> Cetak Laporan
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tombol Laporan -->
  <button id="reportBtn" class="btn btn-info position-fixed" style="bottom: 20px; right: 20px; z-index: 1000;" 
          onclick="generateReport()" disabled>
    <i class="fas fa-file-alt me-2"></i>Laporan Summary
  </button>

  <div class="container-fluid">
    <div class="row">
      <!-- Map Column -->
      <div class="col-md-8 p-0">
        <div id="map"></div>
        <div id="legend" class="position-absolute bottom-0 end-0 m-3">
          <h6><i class="fas fa-map-legend"></i> Legenda</h6>
          <div><i class="fas fa-square text-success"></i> Jalur Baik (Skor 4-5)</div>
          <div><i class="fas fa-square text-warning"></i> Jalur Sedang (Skor 3)</div>
          <div><i class="fas fa-square text-danger"></i> Jalur Buruk (Skor 1-2)</div>
        </div>
      </div>
      
      <!-- Form Column -->
      <div class="col-md-4 sidebar p-3">
        <h3 class="text-center mb-4">
          <i class="fas fa-tree"></i> PENILAIAN LAND CLEARING
        </h3>
        
        <!-- Project Info -->
        <div class="card mb-3">
          <div class="card-header bg-primary text-white">
            <i class="fas fa-info-circle"></i> Informasi Proyek
          </div>
          <div class="card-body">
            <div class="mb-2">
              <label class="form-label">Nama Block <span class="text-danger">*</span></label>
              <input type="text" id="projectName" class="form-control" required>
            </div>
            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label">Tanggal <span class="text-danger">*</span></label>
                <input type="date" id="assessmentDate" class="form-control" required>
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label">Jalur Sampel <span class="text-danger">*</span></label>
                <select id="sampleLine" class="form-select" required>
                  <option value="">Pilih Jalur</option>
                  <!-- Options will be populated by JS -->
                </select>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Koordinat <span class="text-danger">*</span></label>
              <div class="input-group">
                <input type="text" id="latitude" class="form-control" placeholder="Lintang" readonly required>
                <input type="text" id="longitude" class="form-control" placeholder="Bujur" readonly required>
                <button class="btn btn-outline-secondary" type="button" onclick="getLocation()">
                  <i class="fas fa-location-crosshairs"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Assessment Form -->
        <div class="card mb-3">
          <div class="card-header bg-primary text-white">
            <i class="fas fa-clipboard-check"></i> Form Penilaian
          </div>
          <div class="card-body" id="criteria-section">
            <!-- Criteria will be loaded here -->
          </div>
        </div>

        <!-- Photo Upload -->
        <div class="card mb-3">
          <div class="card-header bg-primary text-white">
            <i class="fas fa-camera"></i> Dokumentasi
          </div>
          <div class="card-body">
            <input type="file" id="photoUpload" accept="image/*" class="form-control mb-2" multiple>
            <div id="photoPreview" class="d-flex flex-wrap gap-2"></div>
          </div>
        </div>

        <!-- Submit Button -->
        <button id="submitBtn" class="btn btn-success w-100 py-2" onclick="saveAssessment()">
          <i class="fas fa-save"></i> SIMPAN PENILAIAN
        </button>

        <!-- Results Summary -->
        <div class="card mt-3 d-none" id="resultsCard">
          <div class="card-header bg-info text-white">
            <i class="fas fa-chart-bar"></i> Hasil
          </div>
          <div class="card-body">
            <div id="scoreSummary"></div>
            <canvas id="scoreChart" width="100%" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <!-- Library untuk export PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script>
    // Global Variables
    let map;
    let drawnItems = new L.FeatureGroup();
    let assessmentData = {};
    let currentLine = null;
    let assessmentChart = null;
    let gradeChart = null;
    let reportMap = null;
    const { jsPDF } = window.jspdf;
    
    const criteria = [
      {
        id: "trench_straightness",
        name: "Kelurusan Parit",
        levels: [
          { score: 5, desc: "Lurus sempurna (deviasi <1m)" },
          { score: 4, desc: "Hampir lurus (deviasi 1-2m)" },
          { score: 3, desc: "Sedang (deviasi 2-3m)" },
          { score: 2, desc: "Tidak lurus (deviasi 3-5m)" },
          { score: 1, desc: "Berkelok-kelok (deviasi >5m)" }
        ],
        tool: "Tali/Total Station"
      },
      {
        id: "trench_depth",
        name: "Kedalaman Parit",
        levels: [
          { score: 5, desc: "Kedalaman tepat (100±5cm)" },
          { score: 4, desc: "Kedalaman hampir tepat (100±10cm)" },
          { score: 3, desc: "Kedalaman sedang (100±20cm)" },
          { score: 2, desc: "Kedalaman tidak tepat (100±30cm)" },
          { score: 1, desc: "Kedalaman sangat tidak tepat (<60±10cm)" }
        ],
        tool: "Meteran"
      },
      {
        id: "trench_width",
        name: "Lebar Parit",
        levels: [
          { score: 5, desc: "Lebar tepat (100±5cm)" },
          { score: 4, desc: "Lebar hampir tepat (100±10cm)" },
          { score: 3, desc: "Lebar sedang (100±30cm)" },
          { score: 2, desc: "Lebar tidak tepat (100±50cm)" },
          { score: 1, desc: "Lebar sangat tidak tepat (>100±50cm)" }
        ],
        tool: "Meteran"
      },
      {
        id: "soil_compaction",
        name: "Pemadatan Tanah",
        levels: [
          { score: 5, desc: "Pemadatan sempurna (tidak ada rongga di jalur tanam)" },
          { score: 4, desc: "Pemadatan baik (sedikit rongga di jalur tanam)" },
          { score: 3, desc: "Pemadatan cukup (beberapa rongga jalur tanam)" },
          { score: 2, desc: "Pemadatan kurang (banyak rongga kecil jalur tanam)" },
          { score: 1, desc: "Pemadatan buruk (rongga besarjalur tanam)" }
        ],
        tool: "Visual/Water Test"
      },
      {
        id: "cleaning_quality",
        name: "Kebersihan Area",
        levels: [
          { score: 5, desc: "Bersih sempurna (tidak ada sampah/sisa tebangan)" },
          { score: 4, desc: "Bersih (sedikit sampah/sisa tebangan)" },
          { score: 3, desc: "Cukup bersih (beberapa sampah/sisa tebangan)" },
          { score: 2, desc: "Kurang bersih (banyak sampah/sisa tebangan)" },
          { score: 1, desc: "Kotor (sampah/sisa tebangan berserakan)" }
        ],
        tool: "Visual"
      },
      {
        id: "slope_consistency",
        name: "Konsistensi Kemiringan",
        levels: [
          { score: 5, desc: "Kemiringan konsisten (2% ±0.5%)" },
          { score: 4, desc: "Kemiringan hampir konsisten (2% ±1%)" },
          { score: 3, desc: "Kemiringan cukup konsisten (2% ±2%)" },
          { score: 2, desc: "Kemiringan tidak konsisten (2% ±3%)" },
          { score: 1, desc: "Kemiringan sangat tidak konsisten (>2% ±3%)" }
        ],
        tool: "Waterpass/Total Station"
      },
      {
        id: "obstacle_handling",
        name: "Penanganan Hambatan",
        levels: [
          { score: 5, desc: "Penanganan sempurna (solusi tepat untuk semua hambatan)" },
          { score: 4, desc: "Penanganan baik (solusi tepat untuk sebagian besar hambatan)" },
          { score: 3, desc: "Penanganan cukup (solusi cukup untuk hambatan)" },
          { score: 2, desc: "Penanganan minimal (solusi dasar untuk hambatan)" },
          { score: 1, desc: "Penanganan buruk (mengabaikan hambatan)" }
        ],
        tool: "Visual"
      }
    ];

    // Initialize Map
    function initMap() {
      map = L.map('map').setView([3.70, 117.60], 12);
      
      // Basemaps
      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      });
      
      const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
      });

      // Layer WMS dari GeoServer
      const geoServerWMS = L.tileLayer.wms("http://gis.julongindonesia.com:8080/geoserver/mau/wms", {
        layers: 'mau:tanam_a13_a16_29072025b',
        format: 'image/png',
        transparent: true,
        version: '1.1.0',
        crs: L.CRS.EPSG4326,
        bbox: [564414.313675461, 403409.530999905, 566680.623203461, 404506.640407905],
        width: 768,
        height: 371,
        attribution: 'Data Tanam © Julong Indonesia'
      });

      osm.addTo(map);
      
      // Layer control
      const baseLayers = {
        "Peta Standar": osm,
        "Satelit": satellite
      };
      
      const overlays = {
        "Foto Udara": geoServerWMS,
        "Jalur Penilaian": drawnItems
      };
      
      L.control.layers(baseLayers, overlays).addTo(map);
      
      // Add drawing tools
      const drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: {
          polygon: false,
          circle: false,
          marker: true,
          circlemarker: false,
          polyline: true,
          rectangle: false
        }
      });
      map.addControl(drawControl);
      
      map.on(L.Draw.Event.CREATED, function(e) {
        const layer = e.layer;
        drawnItems.addLayer(layer);
        if (layer instanceof L.Marker) {
          const latlng = layer.getLatLng();
          document.getElementById('latitude').value = latlng.lat.toFixed(6);
          document.getElementById('longitude').value = latlng.lng.toFixed(6);
        }
      });
    }

    // [Bagian fungsi lainnya tetap sama seperti sebelumnya...]
    // ... (loadGeoJSON, loadExistingAssessments, generateCriteriaForm, loadLineAssessment, dll)
    
    // Fungsi untuk generate report
    function generateReport() {
      if (Object.keys(assessmentData).length === 0) {
        showErrorAlert("Tidak ada data penilaian untuk di-generate");
        return;
      }

      const projectName = document.getElementById('projectName').value || 'Proyek Land Clearing';
      const assessmentDate = document.getElementById('assessmentDate').value || new Date().toISOString().split('T')[0];
      
      // Isi informasi proyek
      document.getElementById('reportProjectInfo').innerHTML = `
        <p><strong>Nama Proyek:</strong> ${projectName}</p>
        <p><strong>Tanggal Penilaian:</strong> ${new Date(assessmentDate).toLocaleDateString()}</p>
        <p><strong>Total Jalur Dinilai:</strong> ${Object.keys(assessmentData).length}</p>
        <p><strong>Rata-rata Skor:</strong> ${calculateAverageScore().toFixed(2)}/35</p>
        <p><strong>Grade Rata-rata:</strong> ${calculateAverageGrade()}</p>
      `;
      
      // Generate tabel
      const tableBody = document.querySelector('#reportLineTable tbody');
      tableBody.innerHTML = '';
      
      Object.entries(assessmentData).forEach(([line, data]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>Jalur ${line}</td>
          <td>${data.totalScore}/35</td>
          <td><span class="badge grade-${data.grade} grade-badge">${data.grade}</span></td>
          <td><button class="btn btn-sm btn-outline-primary" onclick="showLineDetail('${line}')">Detail</button></td>
        `;
        tableBody.appendChild(row);
      });
      
      // Generate grade chart
      generateGradeChart();
      
      // Generate mini map
      generateReportMap();
      
      // Aktifkan tombol report
      document.getElementById('reportBtn').disabled = false;
      
      // Tampilkan modal
      const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
      reportModal.show();
    }

    // Fungsi untuk menghitung rata-rata skor
    function calculateAverageScore() {
      const scores = Object.values(assessmentData).map(item => item.totalScore);
      return scores.reduce((sum, score) => sum + score, 0) / scores.length;
    }

    // Fungsi untuk menghitung grade rata-rata
    function calculateAverageGrade() {
      const grades = Object.values(assessmentData).map(item => {
        switch(item.grade) {
          case 'A': return 5;
          case 'B': return 4;
          case 'C': return 3;
          case 'D': return 2;
          case 'E': return 1;
          default: return 0;
        }
      });
      
      const avg = grades.reduce((sum, grade) => sum + grade, 0) / grades.length;
      return String.fromCharCode(70 - Math.round(avg)); // Konversi ke grade A-E
    }

    // Fungsi untuk generate chart grade
    function generateGradeChart() {
      const ctx = document.getElementById('gradeChart').getContext('2d');
      
      // Hitung distribusi grade
      const gradeCounts = { A: 0, B: 0, C: 0, D: 0, E: 0 };
      Object.values(assessmentData).forEach(item => {
        gradeCounts[item.grade]++;
      });
      
      if (gradeChart) {
        gradeChart.destroy();
      }
      
      gradeChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['A', 'B', 'C', 'D', 'E'],
          datasets: [{
            data: Object.values(gradeCounts),
            backgroundColor: [
              '#28a745', // A - hijau
              '#17a2b8', // B - biru
              '#ffc107', // C - kuning
              '#fd7e14', // D - oranye
              '#dc3545'  // E - merah
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const value = context.raw;
                  const percentage = Math.round((value / total) * 100);
                  return `${context.label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // Fungsi untuk generate mini map di report
    function generateReportMap() {
      if (reportMap) {
        reportMap.remove();
      }
      
      reportMap = L.map('reportMap', {
        zoomControl: false,
        attributionControl: false
      }).fitBounds([[3.60, 117.50], [3.80, 117.70]]);
      
      // Tambahkan basemap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(reportMap);
      
      // Tambahkan layer penilaian
      Object.entries(assessmentData).forEach(([line, data]) => {
        if (data.geojson) {
          const geoJsonLayer = L.geoJSON(JSON.parse(data.geojson), {
            style: {
              color: getColorForScore(data.totalScore),
              weight: 3,
              opacity: 0.8
            }
          }).bindPopup(`
            <b>Jalur ${line}</b><br>
            Skor: ${data.totalScore}/35<br>
            Grade: ${data.grade}
          `).addTo(reportMap);
        }
      });
    }

    // Fungsi untuk menampilkan detail jalur
    function showLineDetail(line) {
      if (assessmentData[line]) {
        loadLineAssessment(line);
        const reportModal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
        reportModal.hide();
        
        // Scroll ke hasil penilaian
        document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
      }
    }

    // Fungsi untuk export report ke PDF
    async function exportReport() {
      showLoading();
      try {
        const element = document.getElementById('reportModal');
        const canvas = await html2canvas(element, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          logging: true
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('landscape');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save('laporan-penilaian-land-clearing.pdf');
        showSuccessAlert('Laporan berhasil di-export ke PDF');
      } catch (error) {
        console.error('Export error:', error);
        showErrorAlert('Gagal export PDF: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    // Fungsi untuk print report
    function printReport() {
      const printContents = document.getElementById('reportModal').innerHTML;
      const originalContents = document.body.innerHTML;
      
      document.body.innerHTML = printContents;
      window.print();
      document.body.innerHTML = originalContents;
      
      // Set ulang modal
      const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
      reportModal.show();
    }

    // Update saat ada data baru
    function updateReportButton() {
      const reportBtn = document.getElementById('reportBtn');
      reportBtn.disabled = Object.keys(assessmentData).length === 0;
    }

    // [Fungsi helper lainnya tetap sama...]
    // ... (getColorForScore, getBadgeClass, calculateGrade, showLoading, hideLoading, dll)

    // Initialize app
    window.onload = function() {
      initMap();
      generateCriteriaForm();
      loadGeoJSON('sample-lines.geojson');
      document.getElementById('assessmentDate').valueAsDate = new Date();
      
      // Update tombol report saat data berubah
      setInterval(updateReportButton, 1000);
    };
  </script>
</body>
</html>
